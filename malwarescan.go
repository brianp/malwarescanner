package main

import (
	"github.com/brianp/malwarescan/modules"

	"encoding/json"
	"fmt"
	"net/http"
	"net/url"
	"os"
)

func handler(resp http.ResponseWriter, req *http.Request) {
	switch req.Method {
	case "GET":
		url := parseUrl(req.URL)
		defer req.Body.Close()

		file := modules.DownloadFile(url)
		defer os.Remove(file.Name())

		scanResult := modules.Scan(file)
		scanResult.Source = url

		json.NewEncoder(resp).Encode(scanResult)
	default:
		fmt.Fprintf(resp, "Request type not supported")
	}
}

func parseUrl(reqURL *url.URL) *url.URL {
	var getUrl *url.URL
	param := reqURL.Query().Get("url")

	if param != "" {
		getUrl, _ = url.Parse(param)
	}

	return getUrl
}

func main() {
	http.HandleFunc("/scan", handler)
	http.ListenAndServe(":8080", nil)
}
